name: Deploy to GCP

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-southeast1
  BACKEND_SERVICE: cms-prod-backend
  FRONTEND_SERVICE: cms-prod-frontend
  REGISTRY: asia-southeast1-docker.pkg.dev

jobs:
  # ============================================
  # Test Backend
  # ============================================
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Run tests
        working-directory: ./backend
        run: ./mvnw test -B

  # ============================================
  # Test Frontend
  # ============================================
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run lint
        working-directory: ./frontend
        run: npm run lint
      
      - name: Run type check
        working-directory: ./frontend
        run: npm run build

  # ============================================
  # Build and Push Backend
  # ============================================
  build-backend:
    name: Build Backend
    needs: [test-backend]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    outputs:
      image: ${{ steps.build.outputs.image }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet
      
      - name: Build and Push
        id: build
        working-directory: ./backend
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/cms-prod-images/backend:${{ github.sha }}"
          docker build -t $IMAGE .
          docker push $IMAGE
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          
          # Tag as latest
          docker tag $IMAGE ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/cms-prod-images/backend:latest
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/cms-prod-images/backend:latest

  # ============================================
  # Build and Push Frontend
  # ============================================
  build-frontend:
    name: Build Frontend
    needs: [test-frontend]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    outputs:
      image: ${{ steps.build.outputs.image }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet
      
      - name: Build and Push
        id: build
        working-directory: ./frontend
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/cms-prod-images/frontend:${{ github.sha }}"
          docker build \
            --build-arg VITE_API_BASE_URL=/api \
            -t $IMAGE .
          docker push $IMAGE
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          
          # Tag as latest
          docker tag $IMAGE ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/cms-prod-images/frontend:latest
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/cms-prod-images/frontend:latest

  # ============================================
  # Deploy to Cloud Run
  # ============================================
  deploy:
    name: Deploy
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Deploy Backend
        run: |
          gcloud run services update ${{ env.BACKEND_SERVICE }} \
            --image=${{ needs.build-backend.outputs.image }} \
            --region=${{ env.REGION }} \
            --quiet
      
      - name: Deploy Frontend
        run: |
          gcloud run services update ${{ env.FRONTEND_SERVICE }} \
            --image=${{ needs.build-frontend.outputs.image }} \
            --region=${{ env.REGION }} \
            --quiet
      
      - name: Get Service URLs
        run: |
          BACKEND_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} --region=${{ env.REGION }} --format='value(status.url)')
          FRONTEND_URL=$(gcloud run services describe ${{ env.FRONTEND_SERVICE }} --region=${{ env.REGION }} --format='value(status.url)')
          
          echo "### Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** $FRONTEND_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend API:** $BACKEND_URL/api" >> $GITHUB_STEP_SUMMARY
          echo "- **Swagger UI:** $BACKEND_URL/swagger-ui.html" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Health Check
  # ============================================
  health-check:
    name: Health Check
    needs: [deploy]
    runs-on: ubuntu-latest
    
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Check Backend Health
        run: |
          BACKEND_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} --region=${{ env.REGION }} --format='value(status.url)')
          
          for i in {1..5}; do
            if curl -sf "$BACKEND_URL/actuator/health" > /dev/null; then
              echo "Backend is healthy!"
              exit 0
            fi
            echo "Attempt $i failed, waiting..."
            sleep 10
          done
          
          echo "Backend health check failed!"
          exit 1
      
      - name: Check Frontend Health
        run: |
          FRONTEND_URL=$(gcloud run services describe ${{ env.FRONTEND_SERVICE }} --region=${{ env.REGION }} --format='value(status.url)')
          
          for i in {1..5}; do
            if curl -sf "$FRONTEND_URL/health" > /dev/null; then
              echo "Frontend is healthy!"
              exit 0
            fi
            echo "Attempt $i failed, waiting..."
            sleep 10
          done
          
          echo "Frontend health check failed!"
          exit 1
